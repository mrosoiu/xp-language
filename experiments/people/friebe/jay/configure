#!/bin/sh

##
# Configure
#
# $Id$

checkPhpBinary() {
  EXE=$1  
  VERSION=$2

  echo "---> Checking $EXE"
  if [ ! -e $EXE ] ; then
    echo "*** Does not exist"
    return 1;
  fi

  if [ ! -x $EXE ] ; then
    echo "*** Not executable"
    return 1;
  fi
  
  $EXE -r 'exit(intval(PHP_SAPI != "cli" || !version_compare(phpversion(), "'$VERSION'", "ge")));'
  
  if [ 0 != $? ] ; then
    echo "*** Prerequisites not met (CLI sapi, >= $VERSION)"
    return 1;
  fi
  
  $EXE -v
  return 0;
}

# {{{ main
PHPFOUR=""
PHPFIVE=""

while getopts '?h4:5:' COMMAND_LINE_ARGUMENT ; do
  case "$COMMAND_LINE_ARGUMENT" in
    4) PHPFOUR=$OPTARG ;;
    5) PHPFIVE=$OPTARG ;;
    *)
      echo "== Configures JAY experiment =="
      echo "* Example: ./configure"
      echo "  Will guess php4 and php5 cli binaries by using 'which'"
      echo ""    
      echo "* Example: ./configure -4 /usr/local/bin/php4 -5 /usr/local/bin/php5"
      echo "  Will set /usr/local/bin/php4 as PHP4 binary, /usr/local/bin/php5 for PHP5"
      echo ""    
      exit
  esac
done
shift `expr $OPTIND - 1`

if [ "" = "$PHPFOUR" ] ; then 
  echo "===> Guessing php4 binary"
  PHPFOUR=`which php4 || which php`
fi
if [ "" = "$PHPFIVE" ] ; then 
  echo "===> Guessing php5 binary"
  PHPFIVE=`which php5`
fi

# Sanity check
echo "===> Performing checks"
checkPhpBinary $PHPFOUR 4.3.11 || exit
checkPhpBinary $PHPFIVE 5.1.4 || exit

# Create config
echo "===> Creating environment"
echo "# Environment generated @ `date` by $0" > .environment
echo "php4=$PHPFOUR" >> .environment
echo "php5=$PHPFIVE" >> .environment

# Finalize
echo "===> Done"
# }}}
