#!/bin/sh

readEnv() {
  ARG=$1

  if [ ! -e `dirname $0`/.environment ] ; then
    echo "*** Environment not found, please run configure first"
    return 1;
  fi
  
  SETTING=`grep ^$ARG= .environment | cut -d '=' -f 2`
  
  if [ "" = "$SETTING" ] ; then
    echo "*** Setting $ARG not contained in environment!"
    return 1;
  fi
  
  return 0;
}

# {{{ main
readEnv "php4" && PHPFOUR=$SETTING || exit
readEnv "php5" && PHPFIVE=$SETTING || exit

if [ "$OS" = "Windows_NT" ] ; then
  # Cygwin
  REALPATH="cygpath -w"
  TEMP="."
else 
  # Unix
  TEMP="/tmp/"
  REALPATH="realpath"
fi

export COMPILE_CMD="`$REALPATH $PHPFOUR` tophp5.php %s"

$PHPFOUR tophp5.php $1 -o $TEMP/t.php5 1 > $TEMP/errors
if [ $? != 0 ] ; then
  cat $TEMP/errors
  rm $TEMP/errors
  exit
fi

$PHPFIVE -d auto_prepend_file=php5-emit/__xp__.php $TEMP/t.php5 $2 $3 $4 $5 $6 $7 $8 $9

# Cleanup
rm $TEMP/errors $TEMP/t.php5

# }}}
