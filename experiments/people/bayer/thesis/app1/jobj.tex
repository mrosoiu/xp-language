% ********** Appendix 1 **********
\subsection{Java-Objekte in PHP}
\label{sec:app1:jobj}

Turpitude erlaubt es dem Anwender aus PHP heraus Java-Objekte zu erzeugen und Methoden
auf diesen aufzurufen, allerdings gilt es dabei einige Besonderheiten zu beachten.

Zun"achst muss eine Instanz der Klasse \emph{TurpitudeEnvironment} gefunden werden.
Dies kann entweder mittels eines einfach "'new"' geschehen, allerdings findet sich
eine solche auch im PHP-Superglobal \emph{\$\_SERVER}:
\begin{lstlisting}[caption=TurpitudeEnvironment-Instanz]
$turpenv = $_SERVER["TURP_ENV"];
\end{lstlisting}
Der Name, unter dem sich die Instanz finden l"a\ss t, ist in der PHPScriptEngine konfigurierbar,
der Default lautet "'TURP\_ENV"'.
Nachdem dieser Schritt getan ist kann eine Instanz der Klasse \emph{TurpitudeJavaClass}, 
welche eine Java-Klasse repr"asentiert, erzeugt werden:
\begin{lstlisting}[caption=Java-Klassen finden]
$class = $turpenv->findClass("net/xp_framework/turpitude/samples/ExampleClass");
\end{lstlisting}
Wichtig ist hierbei das Format des Klassennamens - er entspricht der JNI-Syntax \cite{JNIHP}.
Mit diesem Objekt k"onnen nun bereits statische Methoden aufgerufen werden, allerdings nicht
ohne zuvor eine Instanz der Klasse \emph{TurpitudeJavaMethod} erzeugt zu haben, diese Klasse
beschreibt eine Java-Methode. Um statisch aufrufbare Methoden zu finden muss die Funktion
\emph{findStaticMethod()} genutzt werden, welche zwei Parameter erwartet: den Methodennamen
und die Methodensignatur, wieder in JNI-Syntax kodiert:
\begin{lstlisting}[caption=statische Methoden finden]
$method = $class->findStaticMethod('staticMethod', '(I)Ljava/lang/String;');
\end{lstlisting}
Jetzt kann die statische Methode aufgerufen werden:
\begin{lstlisting}[caption=statischer Methodenaufruf]
$retval = $class->invokeStatic($method, 17);
\end{lstlisting}
Der erste Parameter der Methode \emph{invokeStatic()} ist die aufzurufende Methode,
alle weiteren werden der Java Virtual Machine als Methodenparameter "ubergeben, es
obliegt also dem Anwender sicherzustellen dass die richtige Anzahl Parameter, als auch die
richtigen Typen "ubergeben werden.
Um nun eine Instanz der Java-Klasse erzeugen zu k"onnen muss zun"achst der Konstruktor
gefunden werden, un zwar mittels der Methode \emph{findMethod()}, die wieder die Signatur
des gew"unschten Konstruktors als Parameter erwartet:
\begin{lstlisting}[caption=Konstruktoren finden]
$constructor = $class->findConstructor('(ILjava/lang/String;)V');
\end{lstlisting}
Der so gefunden Konstruktor kann nun als erster Parameter f"ur die Methode \emph{create()}
verwandt werden, jeder weitere Parameter wird wieder an die JVM weitergeleitet. Auf diese
Weise erh"alt man ein Objekt der Klasse \emph{TurpitudeJavaObject}:
\begin{lstlisting}[caption=Konstruktoren finden]
$instance = $class->create($constructor, 1337, 'eleet');
\end{lstlisting}
Um nun Attribute dieser Instanz auslesen und setzen zu k"onnen stehen die beiden Methoden
\emph{javaGet()} und \emph{javaSet()} zur Verf"ugung. Erstere erwartet zwei Parameter, den
Namen des zu setzenden Attributes und dessen Signatur, wiederum JNI-kodiert. Letztere erwartet
einen dritten Parameter, den neuen Wert:
\begin{lstlisting}[caption=Attribute lesen und schreiben]
$int = $instance->javaGet('intval', 'I');
$instance->javaSet('intval', 'I', 666);
\end{lstlisting}
Man beachte allerdings: auf diese Weise lassen sich nur nur "offentliche Attribute lesen
und schreiben, sondern auch private. Auch hier obliegt dem Anwender eine gewisse Sorgfaltspflicht.
Weiterhin lassen sich nat"urlich auch Methoden des Java-Objektes aufrufen, allerdings nicht ohne
vorher wieder ein TurpitudeJavaMethod-Objekt zu erzeugen, und zwar unter Verwendung der
Methode \emph{findMethod()}, welche analog zu \emph{findStaticMethod()} funktioniert. Die derart
erzeugte Methode wird - "ahnlich wie bei statischen Methoden - als erster Parameter f"ur die
Methode \emph{javaInvoke()} verwandt:
\begin{lstlisting}[caption=Methoden aufrufen]
$method = $class->findMethod('setValues', '(ILjava/lang/String;)V');
$instance->javaInvoke($method, 1338, 'eleeter');
\end{lstlisting}
Allerdings k"onnen Java-Methoden auch mit etwas weniger Aufwand aufgerufen werden:
jeglicher Methodenaufruf auf einem Objekt der Klasse \emph{TurpitudeJavaObject} wird an die
JVM weitergeleitet, wenn es sich nicht um einen Aufruf mit dem Namen \emph{javaGet}, \emph{javaSet}
oder \emph{javaInvoke} handelt. In diesem Fall wird allerdings erwartet, dass der erste Parameter
die Signatur der gew"unschten Methode enth"alt:
\begin{lstlisting}[caption=direkter Methodenaufruf]
$result = $instance->getDate('()Ljava/util/Date;');
\end{lstlisting}
Das \emph{TurpitudeEnvironment} bietet noch eine weitere n"utzliche Methode an: \emph{instanceOf}.
Sie funktioniert "ahnlich wie der Java-Operator \emph{instanceof}, allerdings nur
auf Objekten der Klasse \emph{TurpitudeJavaObject}. Diese Methode erwartet als ersten Parameter
das zu "uberpr"ufende Objekt, und als zweiten Parameter entweder einen JNI-kodierten Klassennamen,
oder eine Instanz der Klasse \emph{TurpitudeJavaClass}:
\begin{lstlisting}[caption=instanceOf]
$turpenv->instanceOf($instance, 'java/util/Date');
$turpenv->instanceOf($instance, $class);
\end{lstlisting}
Schlussendlich soll noch erw"ahnt werden, dass PHP-Objekte der Klassen
\emph{TurpitudeJavaClass} und \emph{TurpitudeJavaObject} nicht als PHPObject, sondern als "'echte"'
Java-Objekte an die JVM zur"uckgegeben werden.

Der Quelltext dieses Beispieles befindet sich in der Datei \emph{ObjectSample.java}, 
und kann mittels des Befehls \emph{make objects} ausgef"uhrt werden. Der Quelltext der
verwendeten Beispielklasse befindet sich in der Datei \emph{ExampleClass.java}.

% ********** End of appendix **********
