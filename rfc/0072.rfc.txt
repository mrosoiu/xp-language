RFC XXXX: 
========================================================================
$Id: template.txt 5001 2005-04-18 12:10:58Z friebe $

@authors: gellweiler
@created: Tue Sep 12 15:27:01 CEST 2006
@status: draft
@category: peer.server

Scope of Change
---------------
peer.server.Server classes will call 2 additional protocol methods 
to initialize protocol and to handle idle times.

Rationale
---------
Need to initialize protocol and update protocol data
in intervals between client connects.

Functionality
-------------

Refactoring of peer.server.PreforkingServer will provide a
method handleChild():

<?php
  /**
   * Handle a forked child
   *
   * @access  protected
   */
  function handleChild() {

    // Handle initialization of protocol. This
    // is called once for every new child created
    if (FALSE === $this->protocol->initialize()) return;

    $requests= 0;
    while ($requests < $this->maxrequests) {
      try(); {

        $timeout= time() + $this->timeout;
        while (time() < $timeout) {
          $m= &$this->socket->accept();
          usleep(1);
        }
      } if (catch('IOException', $e)) {
        $this->cat && $this->cat->warn('Child', getmypid(), 'in accept ~', $e);
        exit(-1);
      }

      // Handle idle loop of protocol.
      if (!$m) {
        if (FALSE === $this->protocol->handleIdle()) return;
        continue;
      }

      // ...
      // Handle client connect
    }
  }
?>

The initialize method of the protocol will be called on start of the process,
e.g. in peer.server.ForkingServer and PreforkingServer everytime a child is
forked. After a given timout when no incoming connections could be accepted, 
the Server calls a method handleIdle(). This provides the possibility to interrupt
idle times while waiting on client connects.

Security considerations
-----------------------
n/a

Speed impact
------------
n/a

Dependencies
------------
n/a

Related documents
-----------------
- http://experiments.xp-framework.net/?arena,peking
  Experiment


Comments
--------
- gellweiler, Tue Sep 12 15:45:59 CEST 2006
  The method names should be discussed. Currently there is only 
  an implementation for peer.server.PreforkingServer in
  http://experiments.xp-framework.net/?arena,peking,peer,server/PreforkingServer.class.php

<EOF>
